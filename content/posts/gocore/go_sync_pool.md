---
title: "临时对象池 sync.Pool"
date: 2020-12-28T18:20:06+08:00
toc: true
isCJKLanguage: true
tags: 
  - Go
---

sync.Pool 类型可以被称为临时对象池，它的值可以被用来存储临时的对象。与 Go 语言的很多同步工具一样，sync.Pool 也属于结构体类型，它的值在真正被使用后，就不应该再被复制了。

这里的临时对象的意思是：不需要持久使用的某一类值。这类值对程序来说可有可无，如果有则更好。它们的创建或销毁可以在任何时候发生，并且完全不会影响到程序的功能。

同时，它们也应该是无需区分的，其中的任何一个值都可以代替另一个。如果某类值完全满足上述条件，那么就可以把它们存储到临时对象池中。例如，我们可以把临时对象池当做某种数据的缓存来用，这也是临时对象池的主要用途。

sync.Pool 类型只有两个方法：Put 和 Get。Put 用于在当前的池中存放临时对象，它接受一个 interface{} 类型的参数。Get 用于从当前的池中获取临时对象，它会返回一个 interface{} 类型的值。

更具体的说，Get 方法可能会从当前的池中删除掉任何一个值，然后把这个值作为结果返回。如果当前池中没有任何值，那么这个方法就会使用当前池的 New 字段创建一个新值，并直接将其返回。

sync.Pool 类型的 New 字段代表创建临时对象的函数。它是一个没有参数但有唯一结果的函数类型：`New func() interface{}`。这个函数是 Get 方法最后的临时对象获取手段。如果 Get 方法到了最后扔无法获取到一个值，那么就会调用该函数。该函数的结果值并不会被存入当前的临时对象池中，而是直接返回给 Get 方法的调用方。

这里的 New 字段的实际值需要我们在初始化时给定。否则调用它的 Get 方法时就有可能会得到 nil。所以 sync.Pool 类型不是开箱即用的。

标准库代码包 fmt 就使用到了 sync.Pool 类型。这个包会创建一个用于缓存某类临时对象的 sync.Pool 类型值，并将这个值赋给一个名为 ppFree 的变量。这类临时对象可以识别、格式化和暂存需要打印的内容。

```go
var ppFree = sync.Pool{
     New: func() interface{} { return new(pp) },
}
```

临时对象池 ppFree 的 New 字段在被调用的时候，总是会返回一个全新的 pp 类型值的指针（即临时对象）。这就保证了 ppFree 的 Get 方法总能返回一个可以包含需要打印内容的值。

pp 类型是 fmt 包中的私有类型，它有很多实现了不同功能的方法。不过，这里的重点是，它的每一个值都是独立的、平等的和可重用的。

> 更具体地说，这些对象既互不干扰，又不会受到外部状态的影响。它们几乎只针对某个需要打印内容的缓冲区而已。由于 fmt 包中的代码在真正使用这些临时对象之前，总是会先对其进行重置，所以它们并不在意取到的是哪一个临时对象。这就是临时对象的平等性的具体体现。

另外，这些代码在使用完临时对象之后，都会先抹掉其中已缓冲的内容，然后再把它存放到 ppFree 中。这样就为重用这类临时对象做好了准备。

众所周知的 fmt.Println、fmt.Printf 等打印函数都是如此使用 ppFree，以及其中的临时对象的。因此，在程序同时执行很多的打印函数调用的时候，ppFree 可以及时地把它缓存的临时对象提供给它们，以加快执行的速度。

而当程序在一段时间内不再执行打印函数调用时，ppFree 中的临时对象又能够被及时地清理掉，以节省内存空间。

在这个维度上，临时对象池可以帮助程序实现可伸缩性。这就是它的最大价值。